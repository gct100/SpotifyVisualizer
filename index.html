<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chromebook Spotify Visualizer</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #000;
      overflow: hidden;
      font-family: sans-serif;
      color: white;
    }
    #login {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px 40px;
      background: #1db954;
      color: white;
      border-radius: 12px;
      font-size: 1.2rem;
      text-decoration: none;
    }
    canvas {
      display: block;
    }
  </style>
</head>
<body>
  <a id="login" href="#">Login to Spotify</a>
  <canvas id="visualizer"></canvas>

  <script>
    const clientId = '8788664160af45f78733ba1a3fdd0918';
    const redirectUri = 'https://webspotifyvisualizer.netlify.app/';
    const scopes = 'user-read-playback-state user-read-currently-playing';

    async function generateCodeVerifier() {
      const array = new Uint8Array(64);
      window.crypto.getRandomValues(array);
      return btoa(String.fromCharCode.apply(null, array))
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=+$/, '');
    }

    async function sha256(plain) {
      const encoder = new TextEncoder();
      const data = encoder.encode(plain);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return new Uint8Array(hash);
    }

    function base64urlencode(a) {
      return btoa(String.fromCharCode(...a))
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=+$/, '');
    }

    async function pkceChallengeFromVerifier(verifier) {
      const hashed = await sha256(verifier);
      return base64urlencode(hashed);
    }

    async function initiateLogin() {
      const verifier = await generateCodeVerifier();
      const challenge = await pkceChallengeFromVerifier(verifier);
      localStorage.setItem('verifier', verifier);
      const params = new URLSearchParams({
        response_type: 'code',
        client_id: clientId,
        scope: scopes,
        redirect_uri: redirectUri,
        code_challenge_method: 'S256',
        code_challenge: challenge
      });
      window.location.href = `https://accounts.spotify.com/authorize?${params.toString()}`;
    }

    async function getAccessToken(code) {
      const verifier = localStorage.getItem('verifier');
      const body = new URLSearchParams({
        client_id: clientId,
        grant_type: 'authorization_code',
        code: code,
        redirect_uri: redirectUri,
        code_verifier: verifier
      });
      const res = await fetch('https://accounts.spotify.com/api/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: body
      });
      return res.json();
    }

    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');

    if (code) {
      document.getElementById('login').style.display = 'none';
      getAccessToken(code).then(data => {
        if (data.access_token) {
          history.replaceState(null, '', redirectUri);
          resizeCanvas();
          drawVisualizer();
        } else {
          console.error('Failed to get access token:', data);
        }
      });
    } else {
      document.getElementById('login').addEventListener('click', e => {
        e.preventDefault();
        initiateLogin();
      });
    }

    const canvas = document.getElementById('visualizer');
    const ctx = canvas.getContext('2d');

    function drawVisualizer() {
      let bars = 64;
      let radius = Math.min(canvas.width, canvas.height) / 4;
      let centerX = canvas.width / 2;
      let centerY = canvas.height / 2;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#1db954';
      for (let i = 0; i < bars; i++) {
        const angle = (Math.PI * 2 / bars) * i;
        const length = 20 + Math.random() * 100;
        const x = centerX + Math.cos(angle) * radius;
        const y = centerY + Math.sin(angle) * radius;
        const xEnd = centerX + Math.cos(angle) * (radius + length);
        const yEnd = centerY + Math.sin(angle) * (radius + length);
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(xEnd, yEnd);
        ctx.strokeStyle = `hsl(${(angle * 180/Math.PI)}, 100%, 50%)`;
        ctx.lineWidth = 4;
        ctx.stroke();
      }
      requestAnimationFrame(drawVisualizer);
    }

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
  </script>
</body>
</html>
